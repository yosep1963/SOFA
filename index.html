<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="중환자실/응급실용 SOFA 점수 계산기 - Sepsis 진단 도구">
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SOFA Calc">

    <title>SOFA Score Calculator</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        score0: { light: '#F3F4F6', dark: '#374151' },
                        score1: { light: '#FEF3C7', dark: '#78350F' },
                        score2: { light: '#FDE047', dark: '#A16207' },
                        score3: { light: '#FB923C', dark: '#C2410C' },
                        score4: { light: '#EF4444', dark: '#B91C1C' },
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom styles */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        .score-badge {
            min-width: 2rem;
            text-align: center;
        }

        /* Smooth transitions */
        .section-card {
            transition: all 0.3s ease;
        }

        /* Safe area for notch devices */
        @supports (padding-top: env(safe-area-inset-top)) {
            .sticky-header {
                padding-top: env(safe-area-inset-top);
            }
            .main-content {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <!-- Sticky Header -->
    <header class="sticky-header sticky top-0 z-50 bg-blue-600 dark:bg-blue-800 text-white shadow-lg">
        <div class="max-w-lg mx-auto px-4 py-3">
            <div class="flex items-center justify-between mb-2">
                <h1 class="text-lg font-bold">SOFA Score Calculator</h1>
                <button id="darkModeToggle" class="p-2 rounded-lg bg-blue-500 dark:bg-blue-700 hover:bg-blue-400 dark:hover:bg-blue-600 transition">
                    <svg id="sunIcon" class="w-5 h-5 hidden dark:block" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                    </svg>
                    <svg id="moonIcon" class="w-5 h-5 block dark:hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                    </svg>
                </button>
            </div>

            <div class="flex items-center justify-between">
                <div class="text-center">
                    <div class="text-3xl font-bold" id="totalScore">0</div>
                    <div class="text-xs opacity-80">Total Score</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-semibold" id="mortality">&lt;10%</div>
                    <div class="text-xs opacity-80">예상 사망률</div>
                </div>
            </div>

            <!-- Sepsis Alert -->
            <div id="sepsisAlert" class="hidden mt-3 p-2 bg-red-500 rounded-lg text-center font-semibold animate-pulse">
                Sepsis 진단 기준 충족
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content max-w-lg mx-auto px-4 py-4 space-y-4">

        <!-- Infection Suspicion Checkbox -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md">
            <label class="flex items-center space-x-3 cursor-pointer">
                <input type="checkbox" id="infectionSuspicion" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500">
                <span class="font-medium">감염 의심 (Suspected Infection)</span>
            </label>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 ml-8">
                Sepsis-3 기준: 감염 의심 + SOFA ≥ 2
            </p>
        </div>

        <!-- 1. Respiration Section -->
        <section class="section-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md" id="respirationSection" data-score="0">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold flex items-center">
                    <span class="mr-2">1.</span> 호흡기 (Respiration)
                </h2>
                <span class="score-badge px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 font-bold" id="respirationScore">0</span>
            </div>

            <!-- Input Mode Toggle -->
            <div class="flex space-x-4 mb-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="oxygenMode" value="pao2" checked class="text-blue-600 focus:ring-blue-500">
                    <span class="text-sm">PaO2 (동맥혈)</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="oxygenMode" value="spo2" class="text-blue-600 focus:ring-blue-500">
                    <span class="text-sm">SpO2 (맥박산소)</span>
                </label>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1" id="oxygenLabel">PaO2 (mmHg)</label>
                    <input type="number" id="oxygenValue" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="예: 80">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">O2 유량 (L/min)</label>
                    <input type="number" id="o2Flow" min="0" max="15" step="0.5" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0-15">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3 text-sm">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-2">
                    <span class="text-gray-500 dark:text-gray-400">FiO2:</span>
                    <span class="font-semibold ml-1" id="fio2Display">21%</span>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-2">
                    <span class="text-gray-500 dark:text-gray-400">P/F Ratio:</span>
                    <span class="font-semibold ml-1" id="pfRatioDisplay">-</span>
                </div>
            </div>

            <label class="flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" id="ventilator" class="w-4 h-4 rounded text-blue-600 focus:ring-blue-500">
                <span class="text-sm">인공호흡기 사용 중</span>
            </label>
        </section>

        <!-- 2. Coagulation Section -->
        <section class="section-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md" id="coagulationSection" data-score="0">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold flex items-center">
                    <span class="mr-2">2.</span> 응고 (Coagulation)
                </h2>
                <span class="score-badge px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 font-bold" id="coagulationScore">0</span>
            </div>

            <div>
                <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">혈소판 (cells/μL)</label>
                <input type="number" id="platelets" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="예: 150000">
            </div>

            <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                ≥150,000 (0점) | &lt;150,000 (1점) | &lt;100,000 (2점) | &lt;50,000 (3점) | &lt;20,000 (4점)
            </div>
        </section>

        <!-- 3. Liver Section -->
        <section class="section-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md" id="liverSection" data-score="0">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold flex items-center">
                    <span class="mr-2">3.</span> 간 (Liver)
                </h2>
                <span class="score-badge px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 font-bold" id="liverScore">0</span>
            </div>

            <div>
                <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Bilirubin (mg/dL)</label>
                <input type="number" id="bilirubin" step="0.1" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="예: 1.0">
            </div>

            <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                &lt;1.2 (0점) | 1.2-1.9 (1점) | 2.0-5.9 (2점) | 6.0-11.9 (3점) | ≥12.0 (4점)
            </div>
        </section>

        <!-- 4. Cardiovascular Section -->
        <section class="section-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md" id="cardiovascularSection" data-score="0">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold flex items-center">
                    <span class="mr-2">4.</span> 순환기 (Cardiovascular)
                </h2>
                <span class="score-badge px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 font-bold" id="cardiovascularScore">0</span>
            </div>

            <!-- MAP Input Mode Toggle -->
            <div class="flex space-x-4 mb-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="bpMode" value="sbpdbp" checked class="text-blue-600 focus:ring-blue-500">
                    <span class="text-sm">SBP/DBP 입력</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="bpMode" value="map" class="text-blue-600 focus:ring-blue-500">
                    <span class="text-sm">MAP 직접 입력</span>
                </label>
            </div>

            <!-- SBP/DBP Input -->
            <div id="sbpdbpInput" class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">SBP (mmHg)</label>
                    <input type="number" id="sbp" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="예: 120">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">DBP (mmHg)</label>
                    <input type="number" id="dbp" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="예: 80">
                </div>
            </div>

            <!-- MAP Direct Input -->
            <div id="mapInput" class="hidden mb-3">
                <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">MAP (mmHg)</label>
                <input type="number" id="mapDirect" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="예: 70">
            </div>

            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-2 mb-3 text-sm">
                <span class="text-gray-500 dark:text-gray-400">계산된 MAP:</span>
                <span class="font-semibold ml-1" id="mapDisplay">-</span>
            </div>

            <!-- Vasopressor Selection -->
            <div>
                <label class="block text-sm text-gray-600 dark:text-gray-400 mb-2">승압제 (Vasopressor)</label>
                <select id="vasopressor" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="none">없음 (None)</option>
                    <option value="dopamine_low">Dopamine ≤5 μg/kg/min</option>
                    <option value="dobutamine">Dobutamine (any dose)</option>
                    <option value="dopamine_mid">Dopamine >5 μg/kg/min</option>
                    <option value="ne_epi_low">NE/Epi ≤0.1 μg/kg/min</option>
                    <option value="dopamine_high">Dopamine >15 μg/kg/min</option>
                    <option value="ne_epi_high">NE/Epi >0.1 μg/kg/min</option>
                </select>
            </div>
        </section>

        <!-- 5. CNS Section -->
        <section class="section-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md" id="cnsSection" data-score="0">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold flex items-center">
                    <span class="mr-2">5.</span> 중추신경계 (CNS)
                </h2>
                <span class="score-badge px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 font-bold" id="cnsScore">0</span>
            </div>

            <div>
                <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">GCS Score</label>
                <div class="flex items-center space-x-2">
                    <select id="gcs" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="15">15 (정상)</option>
                        <option value="14">14</option>
                        <option value="13">13</option>
                        <option value="12">12</option>
                        <option value="11">11</option>
                        <option value="10">10</option>
                        <option value="9">9</option>
                        <option value="8">8</option>
                        <option value="7">7</option>
                        <option value="6">6</option>
                        <option value="5">5</option>
                        <option value="4">4</option>
                        <option value="3">3 (최저)</option>
                    </select>
                    <button id="gcsCalcBtn" type="button" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 dark:bg-purple-700 dark:hover:bg-purple-600 text-white font-medium rounded-lg transition flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        </svg>
                        <span>계산</span>
                    </button>
                </div>
            </div>

            <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                15 (0점) | 13-14 (1점) | 10-12 (2점) | 6-9 (3점) | &lt;6 (4점)
            </div>
        </section>

        <!-- 6. Renal Section -->
        <section class="section-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md" id="renalSection" data-score="0">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold flex items-center">
                    <span class="mr-2">6.</span> 신장 (Renal)
                </h2>
                <span class="score-badge px-3 py-1 rounded-full bg-gray-200 dark:bg-gray-700 font-bold" id="renalScore">0</span>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Creatinine (mg/dL)</label>
                    <input type="number" id="creatinine" step="0.1" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="예: 1.0">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">소변량 (mL/day)</label>
                    <input type="number" id="urineOutput" class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="선택입력">
                </div>
            </div>

            <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                &lt;1.2 (0점) | 1.2-1.9 (1점) | 2.0-3.4 (2점) | 3.5-4.9 또는 소변량 &lt;500 (3점) | ≥5.0 또는 소변량 &lt;200 (4점)
            </div>
        </section>

        <!-- Reset Button -->
        <button id="resetBtn" class="w-full py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-xl shadow-md transition">
            초기화
        </button>

        <!-- Disclaimer -->
        <div class="text-center text-xs text-gray-500 dark:text-gray-400 py-4">
            <p>본 앱은 참고용이며, 의료 전문가의 판단을 대체하지 않습니다.</p>
            <p class="mt-1">SOFA Score Calculator v1.1</p>
        </div>

    </main>

    <!-- GCS Calculator Modal -->
    <div id="gcsModal" class="fixed inset-0 z-50 hidden">
        <!-- Overlay -->
        <div id="gcsModalOverlay" class="absolute inset-0 bg-black bg-opacity-50"></div>

        <!-- Modal Content -->
        <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Modal Header -->
            <div class="bg-purple-600 dark:bg-purple-800 text-white px-4 py-3 flex items-center justify-between">
                <h3 class="text-lg font-bold">GCS Calculator</h3>
                <button id="gcsModalClose" class="p-1 hover:bg-purple-500 dark:hover:bg-purple-700 rounded-lg transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4">

                <!-- Intubation Toggle -->
                <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-xl p-3">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="gcsIntubated" class="w-5 h-5 rounded text-yellow-600 focus:ring-yellow-500">
                        <div>
                            <span class="font-medium text-yellow-800 dark:text-yellow-200">기관삽관 환자</span>
                            <p class="text-xs text-yellow-600 dark:text-yellow-400">Verbal 평가 불가 (NT)</p>
                        </div>
                    </label>
                </div>

                <!-- Eye Opening -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-3">
                    <h4 class="font-semibold text-blue-600 dark:text-blue-400 mb-2">Eye Opening (E)</h4>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsEye" value="4" checked class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                            <span class="flex-1"><span class="font-medium">4</span> - Spontaneous (자발적)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsEye" value="3" class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                            <span class="flex-1"><span class="font-medium">3</span> - To voice (음성에)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsEye" value="2" class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                            <span class="flex-1"><span class="font-medium">2</span> - To pain (통증에)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsEye" value="1" class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                            <span class="flex-1"><span class="font-medium">1</span> - None (없음)</span>
                        </label>
                    </div>
                </div>

                <!-- Verbal Response -->
                <div id="gcsVerbalSection" class="bg-gray-50 dark:bg-gray-700 rounded-xl p-3">
                    <h4 class="font-semibold text-green-600 dark:text-green-400 mb-2">Verbal Response (V)</h4>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsVerbal" value="5" checked class="w-4 h-4 text-green-600 focus:ring-green-500">
                            <span class="flex-1"><span class="font-medium">5</span> - Oriented (지남력 정상)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsVerbal" value="4" class="w-4 h-4 text-green-600 focus:ring-green-500">
                            <span class="flex-1"><span class="font-medium">4</span> - Confused (혼란)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsVerbal" value="3" class="w-4 h-4 text-green-600 focus:ring-green-500">
                            <span class="flex-1"><span class="font-medium">3</span> - Inappropriate words (부적절한 단어)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsVerbal" value="2" class="w-4 h-4 text-green-600 focus:ring-green-500">
                            <span class="flex-1"><span class="font-medium">2</span> - Incomprehensible sounds (이해 불가 소리)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsVerbal" value="1" class="w-4 h-4 text-green-600 focus:ring-green-500">
                            <span class="flex-1"><span class="font-medium">1</span> - None (없음)</span>
                        </label>
                    </div>
                </div>

                <!-- Verbal NT (for intubated) -->
                <div id="gcsVerbalNT" class="hidden bg-gray-100 dark:bg-gray-600 rounded-xl p-3">
                    <h4 class="font-semibold text-gray-500 dark:text-gray-400 mb-2">Verbal Response (V)</h4>
                    <div class="text-center py-4">
                        <span class="text-2xl font-bold text-gray-400 dark:text-gray-500">NT</span>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Not Testable (기관삽관)</p>
                    </div>
                </div>

                <!-- Motor Response -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-3">
                    <h4 class="font-semibold text-orange-600 dark:text-orange-400 mb-2">Motor Response (M)</h4>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsMotor" value="6" checked class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                            <span class="flex-1"><span class="font-medium">6</span> - Obeys commands (명령 수행)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsMotor" value="5" class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                            <span class="flex-1"><span class="font-medium">5</span> - Localizes pain (통증 위치 파악)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsMotor" value="4" class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                            <span class="flex-1"><span class="font-medium">4</span> - Withdrawal (회피 반응)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsMotor" value="3" class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                            <span class="flex-1"><span class="font-medium">3</span> - Abnormal flexion (제피질 자세)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsMotor" value="2" class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                            <span class="flex-1"><span class="font-medium">2</span> - Extension (제뇌 자세)</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition">
                            <input type="radio" name="gcsMotor" value="1" class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                            <span class="flex-1"><span class="font-medium">1</span> - None (없음)</span>
                        </label>
                    </div>
                </div>

            </div>

            <!-- Result Section -->
            <div class="border-t border-gray-200 dark:border-gray-700 p-4 bg-gray-50 dark:bg-gray-900">
                <!-- GCS Score Display -->
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="gcsEyeDisplay">E4</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="gcsVerbalDisplay">V5</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="gcsMotorDisplay">M6</div>
                    </div>
                </div>

                <!-- Total Score -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-3 mb-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-3xl font-bold" id="gcsTotalDisplay">15</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400" id="gcsLevelDisplay">정상</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500 dark:text-gray-400">SOFA CNS</div>
                            <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="gcsSofaDisplay">0</div>
                        </div>
                    </div>
                </div>

                <!-- Airway Alert -->
                <div id="gcsAirwayAlert" class="hidden mb-3 p-2 bg-red-100 dark:bg-red-900/50 border border-red-300 dark:border-red-700 rounded-lg text-center">
                    <span class="text-red-700 dark:text-red-300 font-semibold">GCS ≤ 8: 기도 보호 능력 저하 - 기관삽관 고려</span>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-3">
                    <button id="gcsApplyBtn" class="flex-1 py-3 bg-purple-600 hover:bg-purple-700 dark:bg-purple-700 dark:hover:bg-purple-600 text-white font-semibold rounded-xl transition">
                        적용
                    </button>
                    <button id="gcsCancelBtn" class="flex-1 py-3 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-white font-semibold rounded-xl transition">
                        취소
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SOFA Score Calculator - Main JavaScript
        // ============================================

        // DOM Elements
        const elements = {
            // Header
            totalScore: document.getElementById('totalScore'),
            mortality: document.getElementById('mortality'),
            sepsisAlert: document.getElementById('sepsisAlert'),
            darkModeToggle: document.getElementById('darkModeToggle'),

            // Infection
            infectionSuspicion: document.getElementById('infectionSuspicion'),

            // Respiration
            oxygenMode: document.getElementsByName('oxygenMode'),
            oxygenLabel: document.getElementById('oxygenLabel'),
            oxygenValue: document.getElementById('oxygenValue'),
            o2Flow: document.getElementById('o2Flow'),
            fio2Display: document.getElementById('fio2Display'),
            pfRatioDisplay: document.getElementById('pfRatioDisplay'),
            ventilator: document.getElementById('ventilator'),
            respirationScore: document.getElementById('respirationScore'),
            respirationSection: document.getElementById('respirationSection'),

            // Coagulation
            platelets: document.getElementById('platelets'),
            coagulationScore: document.getElementById('coagulationScore'),
            coagulationSection: document.getElementById('coagulationSection'),

            // Liver
            bilirubin: document.getElementById('bilirubin'),
            liverScore: document.getElementById('liverScore'),
            liverSection: document.getElementById('liverSection'),

            // Cardiovascular
            bpMode: document.getElementsByName('bpMode'),
            sbpdbpInput: document.getElementById('sbpdbpInput'),
            mapInput: document.getElementById('mapInput'),
            sbp: document.getElementById('sbp'),
            dbp: document.getElementById('dbp'),
            mapDirect: document.getElementById('mapDirect'),
            mapDisplay: document.getElementById('mapDisplay'),
            vasopressor: document.getElementById('vasopressor'),
            cardiovascularScore: document.getElementById('cardiovascularScore'),
            cardiovascularSection: document.getElementById('cardiovascularSection'),

            // CNS
            gcs: document.getElementById('gcs'),
            cnsScore: document.getElementById('cnsScore'),
            cnsSection: document.getElementById('cnsSection'),

            // Renal
            creatinine: document.getElementById('creatinine'),
            urineOutput: document.getElementById('urineOutput'),
            renalScore: document.getElementById('renalScore'),
            renalSection: document.getElementById('renalSection'),

            // Reset
            resetBtn: document.getElementById('resetBtn')
        };

        // ============================================
        // Dark Mode
        // ============================================
        function initDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true' ||
                          (localStorage.getItem('darkMode') === null &&
                           window.matchMedia('(prefers-color-scheme: dark)').matches);

            if (isDark) {
                document.documentElement.classList.add('dark');
            }
        }

        elements.darkModeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
        });

        initDarkMode();

        // ============================================
        // Score Color Styling
        // ============================================
        function getScoreColor(score) {
            const colors = {
                0: { bg: 'bg-gray-200 dark:bg-gray-700', border: 'border-gray-300 dark:border-gray-600' },
                1: { bg: 'bg-yellow-100 dark:bg-yellow-900', border: 'border-yellow-400 dark:border-yellow-600' },
                2: { bg: 'bg-yellow-300 dark:bg-yellow-700', border: 'border-yellow-500 dark:border-yellow-500' },
                3: { bg: 'bg-orange-300 dark:bg-orange-700', border: 'border-orange-500 dark:border-orange-500' },
                4: { bg: 'bg-red-400 dark:bg-red-700', border: 'border-red-500 dark:border-red-500' }
            };
            return colors[score] || colors[0];
        }

        function updateSectionStyle(section, scoreElement, score) {
            const color = getScoreColor(score);

            // Update score badge
            scoreElement.textContent = score;
            scoreElement.className = `score-badge px-3 py-1 rounded-full font-bold ${color.bg}`;

            // Update section border
            section.className = `section-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-md border-l-4 ${color.border}`;
            section.dataset.score = score;
        }

        // ============================================
        // Calculation Functions
        // ============================================

        // 1. Respiration Score
        function calculateRespirationScore() {
            const o2Flow = parseFloat(elements.o2Flow.value) || 0;
            const oxygenValue = parseFloat(elements.oxygenValue.value);
            const isVentilator = elements.ventilator.checked;

            // Calculate FiO2
            const fio2 = 21 + (o2Flow * 4);
            elements.fio2Display.textContent = `${fio2.toFixed(0)}%`;

            if (!oxygenValue || oxygenValue <= 0) {
                elements.pfRatioDisplay.textContent = '-';
                updateSectionStyle(elements.respirationSection, elements.respirationScore, 0);
                return 0;
            }

            // Calculate P/F Ratio
            const pfRatio = oxygenValue / (fio2 / 100);
            elements.pfRatioDisplay.textContent = pfRatio.toFixed(0);

            // Determine score
            let score = 0;
            if (pfRatio < 100 && isVentilator) {
                score = 4;
            } else if (pfRatio < 200 && isVentilator) {
                score = 3;
            } else if (pfRatio < 300) {
                score = 2;
            } else if (pfRatio < 400) {
                score = 1;
            }

            updateSectionStyle(elements.respirationSection, elements.respirationScore, score);
            return score;
        }

        // 2. Coagulation Score
        function calculateCoagulationScore() {
            const platelets = parseFloat(elements.platelets.value);

            if (!platelets && platelets !== 0) {
                updateSectionStyle(elements.coagulationSection, elements.coagulationScore, 0);
                return 0;
            }

            let score = 0;
            if (platelets < 20000) {
                score = 4;
            } else if (platelets < 50000) {
                score = 3;
            } else if (platelets < 100000) {
                score = 2;
            } else if (platelets < 150000) {
                score = 1;
            }

            updateSectionStyle(elements.coagulationSection, elements.coagulationScore, score);
            return score;
        }

        // 3. Liver Score
        function calculateLiverScore() {
            const bilirubin = parseFloat(elements.bilirubin.value);

            if (!bilirubin && bilirubin !== 0) {
                updateSectionStyle(elements.liverSection, elements.liverScore, 0);
                return 0;
            }

            let score = 0;
            if (bilirubin >= 12.0) {
                score = 4;
            } else if (bilirubin >= 6.0) {
                score = 3;
            } else if (bilirubin >= 2.0) {
                score = 2;
            } else if (bilirubin >= 1.2) {
                score = 1;
            }

            updateSectionStyle(elements.liverSection, elements.liverScore, score);
            return score;
        }

        // 4. Cardiovascular Score
        function calculateCardiovascularScore() {
            const bpMode = document.querySelector('input[name="bpMode"]:checked').value;
            let map;

            if (bpMode === 'sbpdbp') {
                const sbp = parseFloat(elements.sbp.value);
                const dbp = parseFloat(elements.dbp.value);

                if (sbp && dbp) {
                    map = (sbp + 2 * dbp) / 3;
                    elements.mapDisplay.textContent = `${map.toFixed(0)} mmHg`;
                } else {
                    elements.mapDisplay.textContent = '-';
                    map = null;
                }
            } else {
                map = parseFloat(elements.mapDirect.value);
                elements.mapDisplay.textContent = map ? `${map.toFixed(0)} mmHg` : '-';
            }

            const vasopressor = elements.vasopressor.value;

            let score = 0;

            // Vasopressor takes precedence
            if (vasopressor === 'dopamine_high' || vasopressor === 'ne_epi_high') {
                score = 4;
            } else if (vasopressor === 'dopamine_mid' || vasopressor === 'ne_epi_low') {
                score = 3;
            } else if (vasopressor === 'dopamine_low' || vasopressor === 'dobutamine') {
                score = 2;
            } else if (map !== null && map < 70) {
                score = 1;
            }

            updateSectionStyle(elements.cardiovascularSection, elements.cardiovascularScore, score);
            return score;
        }

        // 5. CNS Score
        function calculateCNSScore() {
            const gcs = parseInt(elements.gcs.value);

            let score = 0;
            if (gcs < 6) {
                score = 4;
            } else if (gcs <= 9) {
                score = 3;
            } else if (gcs <= 12) {
                score = 2;
            } else if (gcs <= 14) {
                score = 1;
            }

            updateSectionStyle(elements.cnsSection, elements.cnsScore, score);
            return score;
        }

        // 6. Renal Score
        function calculateRenalScore() {
            const creatinine = parseFloat(elements.creatinine.value);
            const urineOutput = parseFloat(elements.urineOutput.value);

            let score = 0;

            // Check urine output first (if provided)
            if (urineOutput && urineOutput < 200) {
                score = 4;
            } else if (urineOutput && urineOutput < 500) {
                score = 3;
            }

            // Check creatinine
            if (creatinine >= 5.0) {
                score = Math.max(score, 4);
            } else if (creatinine >= 3.5) {
                score = Math.max(score, 3);
            } else if (creatinine >= 2.0) {
                score = Math.max(score, 2);
            } else if (creatinine >= 1.2) {
                score = Math.max(score, 1);
            }

            if (!creatinine && !urineOutput) {
                score = 0;
            }

            updateSectionStyle(elements.renalSection, elements.renalScore, score);
            return score;
        }

        // ============================================
        // Total Score and Mortality
        // ============================================
        function getMortality(score) {
            if (score <= 1) return '<10%';
            if (score <= 3) return '15-20%';
            if (score <= 5) return '20-25%';
            if (score <= 7) return '25-30%';
            if (score <= 9) return '35-40%';
            if (score <= 11) return '40-50%';
            if (score <= 14) return '50-60%';
            return '>80%';
        }

        function calculateTotalScore() {
            const scores = {
                respiration: calculateRespirationScore(),
                coagulation: calculateCoagulationScore(),
                liver: calculateLiverScore(),
                cardiovascular: calculateCardiovascularScore(),
                cns: calculateCNSScore(),
                renal: calculateRenalScore()
            };

            const total = Object.values(scores).reduce((sum, s) => sum + s, 0);

            elements.totalScore.textContent = total;
            elements.mortality.textContent = getMortality(total);

            // Update header color based on total score
            const header = document.querySelector('header');
            if (total >= 10) {
                header.className = 'sticky-header sticky top-0 z-50 bg-red-600 dark:bg-red-800 text-white shadow-lg';
            } else if (total >= 6) {
                header.className = 'sticky-header sticky top-0 z-50 bg-orange-500 dark:bg-orange-700 text-white shadow-lg';
            } else if (total >= 3) {
                header.className = 'sticky-header sticky top-0 z-50 bg-yellow-500 dark:bg-yellow-700 text-white shadow-lg';
            } else {
                header.className = 'sticky-header sticky top-0 z-50 bg-blue-600 dark:bg-blue-800 text-white shadow-lg';
            }

            // Check Sepsis criteria
            const hasInfection = elements.infectionSuspicion.checked;
            if (hasInfection && total >= 2) {
                elements.sepsisAlert.classList.remove('hidden');
            } else {
                elements.sepsisAlert.classList.add('hidden');
            }

            return total;
        }

        // ============================================
        // Event Listeners
        // ============================================

        // Oxygen mode toggle
        elements.oxygenMode.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'pao2') {
                    elements.oxygenLabel.textContent = 'PaO2 (mmHg)';
                    elements.oxygenValue.placeholder = '예: 80';
                } else {
                    elements.oxygenLabel.textContent = 'SpO2 (%)';
                    elements.oxygenValue.placeholder = '예: 95';
                }
                calculateTotalScore();
            });
        });

        // BP mode toggle
        elements.bpMode.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'sbpdbp') {
                    elements.sbpdbpInput.classList.remove('hidden');
                    elements.mapInput.classList.add('hidden');
                } else {
                    elements.sbpdbpInput.classList.add('hidden');
                    elements.mapInput.classList.remove('hidden');
                }
                calculateTotalScore();
            });
        });

        // All input event listeners
        const allInputs = [
            elements.oxygenValue, elements.o2Flow, elements.ventilator,
            elements.platelets, elements.bilirubin,
            elements.sbp, elements.dbp, elements.mapDirect, elements.vasopressor,
            elements.gcs, elements.creatinine, elements.urineOutput,
            elements.infectionSuspicion
        ];

        allInputs.forEach(input => {
            if (input) {
                input.addEventListener('input', calculateTotalScore);
                input.addEventListener('change', calculateTotalScore);
            }
        });

        // Reset button
        elements.resetBtn.addEventListener('click', () => {
            // Reset all inputs
            elements.oxygenValue.value = '';
            elements.o2Flow.value = '';
            elements.ventilator.checked = false;
            elements.platelets.value = '';
            elements.bilirubin.value = '';
            elements.sbp.value = '';
            elements.dbp.value = '';
            elements.mapDirect.value = '';
            elements.vasopressor.value = 'none';
            elements.gcs.value = '15';
            elements.creatinine.value = '';
            elements.urineOutput.value = '';
            elements.infectionSuspicion.checked = false;

            // Reset radio buttons to default
            document.querySelector('input[name="oxygenMode"][value="pao2"]').checked = true;
            document.querySelector('input[name="bpMode"][value="sbpdbp"]').checked = true;
            elements.oxygenLabel.textContent = 'PaO2 (mmHg)';
            elements.oxygenValue.placeholder = '예: 80';
            elements.sbpdbpInput.classList.remove('hidden');
            elements.mapInput.classList.add('hidden');

            // Reset displays
            elements.fio2Display.textContent = '21%';
            elements.pfRatioDisplay.textContent = '-';
            elements.mapDisplay.textContent = '-';

            calculateTotalScore();
        });

        // Initial calculation
        calculateTotalScore();

        // ============================================
        // GCS Calculator Modal
        // ============================================

        // GCS Modal DOM Elements
        const gcsModalElements = {
            modal: document.getElementById('gcsModal'),
            overlay: document.getElementById('gcsModalOverlay'),
            closeBtn: document.getElementById('gcsModalClose'),
            calcBtn: document.getElementById('gcsCalcBtn'),
            applyBtn: document.getElementById('gcsApplyBtn'),
            cancelBtn: document.getElementById('gcsCancelBtn'),
            intubated: document.getElementById('gcsIntubated'),
            verbalSection: document.getElementById('gcsVerbalSection'),
            verbalNT: document.getElementById('gcsVerbalNT'),
            eyeDisplay: document.getElementById('gcsEyeDisplay'),
            verbalDisplay: document.getElementById('gcsVerbalDisplay'),
            motorDisplay: document.getElementById('gcsMotorDisplay'),
            totalDisplay: document.getElementById('gcsTotalDisplay'),
            levelDisplay: document.getElementById('gcsLevelDisplay'),
            sofaDisplay: document.getElementById('gcsSofaDisplay'),
            airwayAlert: document.getElementById('gcsAirwayAlert'),
            eyeRadios: document.getElementsByName('gcsEye'),
            verbalRadios: document.getElementsByName('gcsVerbal'),
            motorRadios: document.getElementsByName('gcsMotor')
        };

        // Open GCS Modal
        function openGcsModal() {
            gcsModalElements.modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            calculateGcsFromModal();
        }

        // Close GCS Modal
        function closeGcsModal() {
            gcsModalElements.modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Get consciousness level description
        function getGcsLevel(gcs, isIntubated) {
            if (isIntubated) {
                // For intubated patients, estimate based on E+M only
                const em = gcs;
                if (em >= 10) return '정상 추정';
                if (em >= 8) return '경도 장애 추정';
                if (em >= 6) return '중등도 장애 추정';
                if (em >= 4) return '중증 장애 추정';
                return '혼수 추정';
            } else {
                if (gcs === 15) return '정상';
                if (gcs >= 13) return '경도 장애';
                if (gcs >= 9) return '중등도 장애';
                if (gcs >= 6) return '중증 장애';
                return '혼수';
            }
        }

        // Get SOFA CNS score from GCS
        function getGcsSofaScore(gcs, isIntubated) {
            if (isIntubated) {
                // For intubated: estimate based on E+M (max 10)
                // Approximate mapping: E+M 10 -> GCS ~15, E+M 2 -> GCS ~3
                const estimatedGcs = Math.round((gcs / 10) * 12 + 3);
                if (estimatedGcs >= 15) return 0;
                if (estimatedGcs >= 13) return 1;
                if (estimatedGcs >= 10) return 2;
                if (estimatedGcs >= 6) return 3;
                return 4;
            } else {
                if (gcs >= 15) return 0;
                if (gcs >= 13) return 1;
                if (gcs >= 10) return 2;
                if (gcs >= 6) return 3;
                return 4;
            }
        }

        // Calculate GCS from modal selections
        function calculateGcsFromModal() {
            const isIntubated = gcsModalElements.intubated.checked;

            // Get selected values
            let eyeScore = 4;
            let verbalScore = 5;
            let motorScore = 6;

            gcsModalElements.eyeRadios.forEach(radio => {
                if (radio.checked) eyeScore = parseInt(radio.value);
            });

            gcsModalElements.verbalRadios.forEach(radio => {
                if (radio.checked) verbalScore = parseInt(radio.value);
            });

            gcsModalElements.motorRadios.forEach(radio => {
                if (radio.checked) motorScore = parseInt(radio.value);
            });

            // Update displays
            gcsModalElements.eyeDisplay.textContent = `E${eyeScore}`;
            gcsModalElements.motorDisplay.textContent = `M${motorScore}`;

            let totalGcs;
            if (isIntubated) {
                // Verbal is NT for intubated patients
                gcsModalElements.verbalSection.classList.add('hidden');
                gcsModalElements.verbalNT.classList.remove('hidden');
                gcsModalElements.verbalDisplay.textContent = 'VT';
                gcsModalElements.verbalDisplay.classList.add('text-gray-400');
                gcsModalElements.verbalDisplay.classList.remove('text-green-600', 'dark:text-green-400');

                totalGcs = eyeScore + motorScore;
                gcsModalElements.totalDisplay.textContent = `${totalGcs}T`;

                // Check airway alert (using E+M <= 5 as equivalent to GCS <= 8)
                if (totalGcs <= 5) {
                    gcsModalElements.airwayAlert.classList.remove('hidden');
                } else {
                    gcsModalElements.airwayAlert.classList.add('hidden');
                }
            } else {
                // Normal calculation
                gcsModalElements.verbalSection.classList.remove('hidden');
                gcsModalElements.verbalNT.classList.add('hidden');
                gcsModalElements.verbalDisplay.textContent = `V${verbalScore}`;
                gcsModalElements.verbalDisplay.classList.remove('text-gray-400');
                gcsModalElements.verbalDisplay.classList.add('text-green-600', 'dark:text-green-400');

                totalGcs = eyeScore + verbalScore + motorScore;
                gcsModalElements.totalDisplay.textContent = totalGcs;

                // Check airway alert
                if (totalGcs <= 8) {
                    gcsModalElements.airwayAlert.classList.remove('hidden');
                } else {
                    gcsModalElements.airwayAlert.classList.add('hidden');
                }
            }

            // Update level and SOFA displays
            const level = getGcsLevel(totalGcs, isIntubated);
            const sofaScore = getGcsSofaScore(totalGcs, isIntubated);

            gcsModalElements.levelDisplay.textContent = level;
            gcsModalElements.sofaDisplay.textContent = sofaScore;

            // Color code the level
            const levelEl = gcsModalElements.levelDisplay;
            levelEl.className = 'text-sm';
            if (level.includes('정상')) {
                levelEl.classList.add('text-green-600', 'dark:text-green-400');
            } else if (level.includes('경도')) {
                levelEl.classList.add('text-yellow-600', 'dark:text-yellow-400');
            } else if (level.includes('중등도')) {
                levelEl.classList.add('text-orange-600', 'dark:text-orange-400');
            } else if (level.includes('중증')) {
                levelEl.classList.add('text-red-500', 'dark:text-red-400');
            } else {
                levelEl.classList.add('text-red-700', 'dark:text-red-300', 'font-semibold');
            }

            return { totalGcs, isIntubated, eyeScore, verbalScore, motorScore };
        }

        // Apply GCS to main form
        function applyGcsToMain() {
            const result = calculateGcsFromModal();
            let gcsValue;

            if (result.isIntubated) {
                // For intubated patients, estimate full GCS
                // E + M, assume V=1T for SOFA calculation
                gcsValue = result.eyeScore + 1 + result.motorScore;
            } else {
                gcsValue = result.totalGcs;
            }

            // Clamp to valid range
            gcsValue = Math.max(3, Math.min(15, gcsValue));

            // Update main dropdown
            elements.gcs.value = gcsValue.toString();

            // Recalculate total SOFA score
            calculateTotalScore();

            // Close modal
            closeGcsModal();
        }

        // GCS Modal Event Listeners
        gcsModalElements.calcBtn.addEventListener('click', openGcsModal);
        gcsModalElements.closeBtn.addEventListener('click', closeGcsModal);
        gcsModalElements.overlay.addEventListener('click', closeGcsModal);
        gcsModalElements.cancelBtn.addEventListener('click', closeGcsModal);
        gcsModalElements.applyBtn.addEventListener('click', applyGcsToMain);

        // Intubation toggle
        gcsModalElements.intubated.addEventListener('change', calculateGcsFromModal);

        // E/V/M radio changes
        gcsModalElements.eyeRadios.forEach(radio => {
            radio.addEventListener('change', calculateGcsFromModal);
        });
        gcsModalElements.verbalRadios.forEach(radio => {
            radio.addEventListener('change', calculateGcsFromModal);
        });
        gcsModalElements.motorRadios.forEach(radio => {
            radio.addEventListener('change', calculateGcsFromModal);
        });

        // Prevent modal close on content click
        document.querySelector('#gcsModal > div:last-child').addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // ============================================
        // Service Worker Registration
        // ============================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
